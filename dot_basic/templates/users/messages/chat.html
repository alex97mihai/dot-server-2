{% extends 'base.html' %}
{% block content %}
<link rel = "stylesheet" type = "text/css" href = "/static/basic/css/chat.css" />

<div class="container-fluid">
  <div class="row h-100 chat-container">
    <div class="col-3">
    </div>
    <div class="col-9">
      {% if messages %}
      <div class="container-fluid" id="message-list">
        {% for message in messages %}
        <div class="row message-row {% if message.user_from.username == user.username %} self {% else %} target {% endif %}">
          <div class="col-12">
            <div class="row">
              <div class="message-name">{{ message.user_from.username }}</div>
            </div>
            <div class="row">
              <div class="message-text wordwrap">{{ message.message }}</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      <div class="row">
      <form class="form-horizontal input-group" method="post" id='message-form'>

        {% csrf_token %}
        <fieldset>
          {% for field in form %}
          <div class="control-group">
            <label class="control-label">{{ field.label }}</label>
            <div class="controls">{{ field }}
            </div>
          </div>
          {% endfor %}

        </fieldset>
              <span class="form-actions input-group-btn" >
          <button type="submit" class="btn btn-primary btn-space" id="message-button">Send Message</button>
        </span>

      </form>
    </div>
    </div>
  </div>
</div>




<!---
 <div class="container-fluid chat-container" >
   <div class="container-fluid" id="message-list">
   </div>

   <div id="login-form">
    <form class="form-horizontal input-group" method="post" id='message-form'>

      {% csrf_token %}
      <fieldset>
        {% for field in form %}
        <div class="control-group">
          <label class="control-label">{{ field.label }}</label>
          <div class="controls">{{ field }} {% if field.help_text %}
            <p class="help-inline"><small>{{ field.help_text }}</small></p>
            {% endif %}
          </div>
        </div>
        {% endfor %}

      </fieldset>
            <span class="form-actions input-group-btn" >
        <button type="submit" class="btn btn-primary btn-space" id="message-button">Send Message</button>
      </span>

    </form>
  </div>
</div>
--->





<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

<script type="text/javascript">
  $(document).ready(
    function()
    {
      document.getElementById("post-message").setAttribute( "autocomplete", "off" );
    }
);
</script>

<script>
setInterval(function() {
    $.ajax({
        type: "GET",
        url: '/get_messages/',  // URL to your view that serves new info
        data: {
                'chat_buddy' : '{{ chat_buddy }}',
        },
    })
    .done(function(response) {
        $('#message-list').append(response);
        // scroll to bottom when new message
        if(response.trim()!=''){
          var objDiv = document.getElementById("message-list");
          objDiv.scrollTop = objDiv.scrollHeight;    };
    });
}, 250)
</script>

<script>
  // Submit message on submit
$('#message-form').on('submit', function(event){
    event.preventDefault();
    console.log("message submitted!")  // sanity check
    create_message();
});
function create_message() {
  console.log("create message is working!") // sanity check
  $.ajax({
      url : "/send_message/", // the endpoint
      type : "POST", // http method
      data : {
                'the_message' : $('#post-message').val(),
                'chat_buddy' : "{{ chat_buddy }}",
                'csrfmiddlewaretoken': '{{ csrf_token }}',
              }, // data sent with the post request
      // handle a successful response
      success : function(json) {
          $('#post-message').val(''); // remove the value from the input
          console.log(json); // log the returned json to the console
          console.log("success"); // another sanity check
      },
      // handle a non-successful response
      error : function(xhr,errmsg,err) {
          $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
              " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
          console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
      }
  });
};
</script>


{% endblock %}
